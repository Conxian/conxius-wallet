<<<<<<< SEARCH
      if (request.payload?.psbt) {
        const pubkeyBuf = Buffer.from(pubkey, "hex");
        const hashes = getPsbtSighashes(
          request.payload.psbt,
          pubkeyBuf,
          network,
        );
        const signatures = [];

        for (const item of hashes) {
          const res = await signNative({
            vault,
            pin,
            path,
            messageHash: item.hash.toString("hex"),
            network,
          });
          signatures.push({
            index: item.index,
            signature: Buffer.from(res.signature, "hex"),
          });
        }
=======
      if (request.payload?.psbt) {
        const pubkeyBuf = Buffer.from(pubkey, "hex");
        const hashes = getPsbtSighashes(
          request.payload.psbt,
          pubkeyBuf,
          network,
        );

        const { getUnsignedTxHex } = await import("./psbt");
        const unsignedTx = getUnsignedTxHex(request.payload.psbt, network);

        const batchRes = await signBatchNative({
          vault,
          pin,
          path,
          hashes: hashes.map(h => h.hash.toString("hex")),
          network,
          payload: unsignedTx
        });

        const signatures = batchRes.signatures.map((res: any, i: number) => ({
          index: hashes[i].index,
          signature: Buffer.from(res.signature, "hex"),
        }));
>>>>>>> REPLACE
